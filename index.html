<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Electric Vehicle Narrative Visualization</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
    <style>
        .scene {
            display: none;
            text-align: center;
        }
        .active {
            display: block;
        }
        .navigation {
            margin: 20px;
            font-size: large;
            text-align: center;
        }
        .legend {
            font-size: 12px;
            text-anchor: start;
        }
        .legend rect {
            stroke: #000;
            stroke-width: 1px;
        }
        .filter-container {
            margin: 10px 0;
        }
        .control-button {
            position: absolute;
            /* top: 0; */
        }
        #prevBtn {
            left: 40%;
        }
        #nextBtn {
            right: 40%;
        }
        #advance-annotations {
            left: 50%;
            transform: translateX(-40%);
        }
    </style>
</head>
<body>
    <h1>Adoption of Electric Vehicles in the Modern Era</h1>
    <div id="scene1" class="scene active">
        <h2>Scene 1: Counts of Vehicles by Model Year</h2>
    </div>
    <div id="scene2" class="scene">
        <h2>Scene 2: Counts of Vehicles by Make</h2>
    </div>
    <div id="scene3" class="scene">
        <h2>Scene 3: Electric Range Analysis of Electric and Hybrid Vehicles</h2>
    </div>
    <div id="exploration" class="scene">
        <h2>Exploration: Interactive Dashboard</h2>
        <svg id="exploration-chart"></svg>
        <div class="filter-container">
            <div class="div">
                <label for="x-axis">X-axis:</label>
                <select id="x-axis">
                    <option value="ModelYear" selected="selected">Model Year</option>
                    <option value="ElectricVehicleType">Electric Vehicle Type</option>
                </select>

                <label for="y-axis">Y-axis:</label>
                <select id="y-axis">
                    <option value="ModelYear">Model Year</option>
                    <option value="ElectricRange" selected="selected">Electric Range</option>
                    <option value="CountOfVehicles">Count of Vehicles</option>
                </select>

                <label for="year-range">Model Year Range:</label>
                <input type="range" id="left-year-range" min="1997" max="2025" step="1" value="1997" multiple>
                <input type="range" id="right-year-range" min="1997" max="2025" step="1" value="2025" multiple>

                <label for="range-slider">Electric Range:</label>
                <input type="range" id="left-range-slider" min="0" max="400" step="1" value="0" multiple>
                <input type="range" id="right-range-slider" min="0" max="400" step="1" value="400" multiple>
            </div>    
            <div class="div">
                <label for="make-dropdown">Make:</label>
                <select id="make-dropdown" multiple>
                    <!-- Options will be populated dynamically -->
                </select>

                <label for="type-dropdown">Electric Vehicle Type:</label>
                <select id="type-dropdown" multiple>
                    <!-- Options will be populated dynamically -->
                </select>

                <label for="model-dropdown">Model:</label>
                <select id="model-dropdown" multiple>
                    <!-- Options will be populated dynamically -->
                </select>

                <button id="reset-button">Reset Filters</button>
            </div>
        </div>
    </div>
    <div class="navigation">
        <button id="prevBtn" class="control-button">Previous</button>
        <button id="nextBtn" class="control-button">Next</button>
        <button id="advance-annotations" class="control-button">Advance Annotations</button>
    </div>
    <div id="tooltip" style="position: absolute; background: lightgray; padding: 5px; border-radius: 3px; display: none;"></div>
    <script>
        // Load data and initialize visualization
        d3.csv('Sampled_Small_EV_Data.csv').then(data => {
            // Parse data
            data.forEach(d => {
                d.ModelYear = +d['Model Year'];
                d.ElectricRange = +d['Electric Range'];
                d.Make = d.Make;
                d.Model = d.Model;
                d.ElectricVehicleType = d['Electric Vehicle Type'];
                d.CAFVEligibility = d['Clean Alternative Fuel Vehicle (CAFV) Eligibility'];
            });
            const margin = {top: 20, right: 150, bottom: 40, left: 100},
                  width = 1280 - margin.left - margin.right,
                  height = 600 - margin.top - margin.bottom;

            let currentScene = 0;
            const scenes = document.querySelectorAll('.scene');
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');


            // Scene 1: Overview of Electric Vehicle Trends            
            const scene1 = d3.select("#scene1");

            const svg1 = scene1.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            const mapVehicleType = (type) => {
                if (type.includes('Battery Electric Vehicle')) return 'EV';
                if (type.includes('Plug-in Hybrid Electric Vehicle')) return 'Hybrid';
                return 'Other';
            };

            const allYears = d3.range(d3.min(data, d => d.ModelYear), d3.max(data, d => d.ModelYear) + 1);

            const yearCounts = d3.nest()
            .key(d => d.ModelYear)
            .key(d => mapVehicleType(d.ElectricVehicleType))
            .rollup(v => v.length)
            .entries(data)
            .map(d => {
                let obj = { year: +d.key };
                d.values.forEach(v => {
                    obj[v.key] = v.value;
                });
                return obj;
            });

            const completeYearCounts = allYears.map(year => {
                const yearData = yearCounts.find(d => d.year === year);
                return yearData ? yearData : { year, EV: 0, Hybrid: 0 };
            });

            const stack = d3.stack()
                .keys(['Hybrid', 'EV']);

            const series = stack(completeYearCounts);

            const x1 = d3.scaleBand()
                .domain(completeYearCounts.map(d => d.year))
                .range([0, width])
                .padding(0.1);

            const y1 = d3.scaleLinear()
                .domain([0, d3.max(series, d => d3.max(d, d => d[1]))]).nice()
                .range([height, 0]);

            const color = d3.scaleOrdinal()
                .domain(['EV', 'Hybrid'])
                .range(['steelblue', 'orange']);

            const bars = svg1.selectAll(".bar-group")
                .data(series)
                .enter().append("g")
                .attr("class", "bar-group")
                .attr("fill", d => color(d.key))

            bars.selectAll(".bar")
                .data(d => d)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x1(d.data.year))
                .attr("y", d => y1(d[1]))
                .attr("width", x1.bandwidth())
                .attr("height", d => y1(d[0]) - y1(d[1]));

            svg1.append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x1).tickFormat(d3.format("d")));

            svg1.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(y1));

            svg1.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom)
                .attr("text-anchor", "middle")
                .text("Model Year");

            svg1.append("text")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 20)
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .text("Count of Vehicles");

            // Scene 1 legend
            const legend = svg1.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width}, 0)`);

            const legendItems = [
                { label: 'Electric Vehicle', color: 'steelblue' },
                { label: 'Hybrid', color: 'orange' }
            ];

            legendItems.forEach((item, i) => {
                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", i * 20)
                    .attr("width", 18)
                    .attr("height", 18)
                    .style("fill", item.color);

                legend.append("text")
                    .attr("x", 30)
                    .attr("y", i * 20 + 14)
                    .text(item.label);
            });

            // Annotations for Scene 1
            const annotations1 = [
                {
                    note: { label: "Energy Policy Act of 2005 extends and increases incentives for EV's", title: "2005" },
                    data: { year: 2005 },
                    dy: -50,
                    dx: -150
                },
                {
                    note: { label: "American Recovery and Reinvestment Act of 2009, that expands tax credit, comes into effect", title: "2010" },
                    data: { year: 2010 },
                    dy: -50,
                    dx: -100
                },
                {
                    note: { label: "FAST Act authorizes funding for EV charging infrastructure", title: "2015" },
                    data: { year: 2015 },
                    dy: -100,
                    dx: -100
                },
                {
                    note: { label: "Federal tax credit extended for homes and businesses", title: "2020" },
                    data: { year: 2020 },
                    dy: -100,
                    dx: -150
                },
                {
                    note: { label: " Infrastructure Investment and Jobs Act provides more funding for EV infrastructure", title: "2021" },
                    data: { year: 2021 },
                    dy: -150,
                    dx: -50
                },
                {
                    note: { label: "Inflation Reduction Act of 2022, which introduces changes to EV tax credit system and extends eligibility of tax credits, comes into effect", title: "2023" },
                    data: { year: 2023 },
                    dy: 30,
                    dx: 150
                }
            ];

            const makeAnnotations1 = d3.annotation()
                .type(d3.annotationLabel)
                .annotations(annotations1)
                .accessors({
                    x: d => x1(d.year) + x1.bandwidth() / 2,
                    y: d => y1(series[series.length - 1][d.year-1997][1])
                });

            svg1.append("g")
                .attr("class", "annotation-group scene1-annotations")
                .call(makeAnnotations1);

            d3.selectAll(".scene1-annotations g.annotation-connector, .scene1-annotations g.annotation-note")
                .style("display", "none");

            let annotationIndex1 = 0;

            function advanceAnnotation1() {
                const annotations = d3.selectAll(".scene1-annotations g.annotation-connector, .scene1-annotations g.annotation-note").nodes();
                console.log(annotationIndex1);
                if (annotationIndex1 < annotations.length) {
                    d3.select(annotations[annotationIndex1]).style("display", null);
                    d3.select(annotations[annotationIndex1 + 1]).style("display", null);
                    annotationIndex1 += 2;
                }
            }

            // Add event listener to the button
            document.getElementById("advance-annotations").addEventListener("click", advanceAnnotation1);

            // Scene 2: Vehicle Counts by Model Year and Make
            const scene2 = d3.select("#scene2");

            const svg2 = scene2.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Identify top 6 makes
            const makeLabelCount = 10;  
            const makeCounts2 = d3.nest()
                .key(d => d.Make)
                .rollup(v => v.length)
                .entries(data)
                .sort((a, b) => d3.descending(a.value, b.value))
                .slice(0, makeLabelCount)
                .map(d => d.key);

            const mapMake = (make) => {
                if (makeCounts2.includes(make)) return make;
                return 'Other';
            };

            const allYears2 = d3.range(d3.min(data, d => d.ModelYear), d3.max(data, d => d.ModelYear) + 1);

            const yearCounts2 = d3.nest()
                .key(d => d.ModelYear)
                .key(d => mapMake(d.Make))
                .rollup(v => v.length)
                .entries(data)
                .map(d => {
                    let obj = { year: +d.key };
                    d.values.forEach(v => {
                        obj[v.key] = v.value;
                    });
                    return obj;
                });

            const completeYearCounts2 = allYears2.map(year => {
                const yearData = yearCounts2.find(d => d.year === year);
                const initialObj = { year };
                makeCounts2.concat('Other').forEach(make => initialObj[make] = 0);
                return yearData ? { ...initialObj, ...yearData } : initialObj;
            });

            const stack2 = d3.stack()
                .keys(makeCounts2.concat('Other').reverse());

            const series2 = stack2(completeYearCounts2);

            const x2 = d3.scaleBand()
                .domain(completeYearCounts2.map(d => d.year))
                .range([0, width])
                .padding(0.1);

            const y2 = d3.scaleLinear()
                .domain([0, d3.max(series2, d => d3.max(d, d => d[1]))]).nice()
                .range([height, 0]);

            const color2 = d3.scaleOrdinal()
                .domain(makeCounts2.concat('Other'))
                .range(d3.schemeCategory10.slice(0, makeLabelCount).concat(['#ccc']));

            const bars2 = svg2.selectAll(".bar-group")
                .data(series2)
                .enter().append("g")
                .attr("class", "bar-group")
                .attr("fill", d => color2(d.key));

            bars2.selectAll(".bar")
                .data(d => d)
                .enter().append("rect")
                .attr("x", d => x2(d.data.year))
                .attr("y", d => y2(d[1]))
                .attr("width", x2.bandwidth())
                .attr("height", d => y2(d[0]) - y2(d[1]));

            svg2.append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x2).tickFormat(d3.format("d")));

            svg2.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(y2));

            svg2.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom)
                .attr("text-anchor", "middle")
                .text("Model Year");

            svg2.append("text")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 20)
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .text("Count of Vehicles");

            // Scene 2 legend
            const legend2 = svg2.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width}, 0)`);

            const legendItems2 = makeCounts2.concat('Other').map((make, i) => ({ label: make, color: color2(make) }));

            legendItems2.forEach((item, i) => {
                legend2.append("rect")
                    .attr("x", 0)
                    .attr("y", i * 20)
                    .attr("width", 18)
                    .attr("height", 18)
                    .style("fill", item.color);

                legend2.append("text")
                    .attr("x", 30)
                    .attr("y", i * 20 + 14)
                    .text(item.label);
            });

            // Annotations for Scene 2
            const annotations2 = [
                {
                    note: { label: "Release of the Tesla Roadster, an electric sports car that started the electric revolution", title: "2008" },
                    data: { year: 2008 },
                    dy: -60,
                    dx: -300
                },
                {
                    note: { label: "Release of the Nissan Leaf, the first mass market electric and zero-emission vehicle", title: "2011" },
                    data: { year: 2011 },
                    dy: -100,
                    dx: -250
                },
                {
                    note: { label: "Release of the Tesla Model S, the top-selling electric car for its first five years", title: "2012" },
                    data: { year: 2012 },
                    dy: -200,
                    dx: -150
                },
                {
                    note: { label: "Launch of the Chevy Bolt, a popular EV known for its affordability", title: "2017" },
                    data: { year: 2017 },
                    dy: -200,
                    dx: -150
                },
                {
                    note: { label: "Orders of Tesla Model 3, a more affordable and popular alternative to Model S, begin fulfillment after 2017 release", title: "2018" },
                    data: { year: 2018 },
                    dy: -150,
                    dx: 50
                }
            ];

            const makeAnnotations2 = d3.annotation()
                .type(d3.annotationLabel)
                .annotations(annotations2)
                .accessors({
                    x: d => x2(d.year) + x2.bandwidth() / 2,
                    y: d => y2(series2[series2.length - 1][d.year-1997][1])
                });

            svg2.append("g")
                .attr("class", "annotation-group scene2-annotations")
                .call(makeAnnotations2);

            d3.selectAll(".scene2-annotations g.annotation-connector, .scene2-annotations g.annotation-note")
                .style("display", "none");

            let annotationIndex2 = 0;

            function advanceAnnotation2() {
                const annotations = d3.selectAll(".scene2-annotations g.annotation-connector, .scene2-annotations g.annotation-note").nodes();
                if (annotationIndex2 < annotations.length) {
                    d3.select(annotations[annotationIndex2]).style("display", null);
                    d3.select(annotations[annotationIndex2 + 1]).style("display", null);
                    annotationIndex2 += 2;
                }
            }

            // Scene 3: Electric Range by Model Year
            const scene3 = d3.select("#scene3");

            const svg3 = scene3.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            const filteredData = data.filter(d => d.ElectricRange > 0);

            const averageRanges = d3.nest()
                .key(d => d.ModelYear)
                .key(d => mapVehicleType(d.ElectricVehicleType))
                .rollup(v => d3.mean(v, d => d.ElectricRange))
                .entries(filteredData)
                .map(d => {
                    let obj = { year: +d.key };
                    d.values.forEach(v => {
                        obj[v.key] = v.value;
                    });
                    return obj;
            });

            const allYears3 = d3.range(d3.min(filteredData, d => d.ModelYear), d3.max(filteredData, d => d.ModelYear) + 1);

            const completeYearCounts3 = allYears3.map(year => {
                const yearData = averageRanges.find(d => d.year === year);
                return yearData ? yearData : { year, EV: 0, Hybrid: 0 };
            });

            const x3 = d3.scaleBand()
                .domain(completeYearCounts3.map(d => d.year))
                .range([0, width])
                .padding(0.1);

            const xSubgroup = d3.scaleBand()
                .domain(["EV", "Hybrid"])
                .range([0, x3.bandwidth()])
                .padding(0.05);

            const y3 = d3.scaleLinear()
                .domain([0, d3.max(completeYearCounts3, d => Math.max(d.EV, d.Hybrid))]).nice()
                .range([height, 0]);

            const color3 = d3.scaleOrdinal()
                .domain(["EV", "Hybrid"])
                .range(["steelblue", "orange"]);

            const bars3 = svg3.selectAll(".bar-group")
                .data(completeYearCounts3)
                .enter().append("g")
                .attr("class", "bar-group")
                .attr("transform", d => "translate(" + x3(d.year) + ",0)");

            bars3.selectAll(".bar")
                .data(d => [
                    { type: "EV", averageRange: d.EV || 0 },
                    { type: "Hybrid", averageRange: d.Hybrid || 0 }
                ])
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => xSubgroup(d.type))
                .attr("y", d => y3(d.averageRange))
                .attr("width", xSubgroup.bandwidth())
                .attr("height", d => height - y3(d.averageRange))
                .attr("fill", d => color3(d.type));

            svg3.append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x3).tickFormat(d3.format("d")));

            svg3.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(y3));

            svg3.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom)
                .attr("text-anchor", "middle")
                .text("Model Year");

            svg3.append("text")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 20)
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .text("Average Electric Range");

            // Scene 3 legend
            const legend3 = svg3.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width}, 0)`);

            const legendItems3 = [
                { label: 'Electric Vehicle', color: 'steelblue' },
                { label: 'Hybrid', color: 'orange' }
            ];

            legendItems3.forEach((item, i) => {
                legend3.append("rect")
                    .attr("x", 0)
                    .attr("y", i * 20)
                    .attr("width", 18)
                    .attr("height", 18)
                    .style("fill", item.color);

                legend3.append("text")
                    .attr("x", 30)
                    .attr("y", i * 20 + 14)
                    .text(item.label);
            });

            // Annotations for Scene 3
            const annotations3 = [
                {
                    note: { label: "Commercial EVs start entering the market", title: "1997" },
                    data: { year: 1997 },
                    dy: -200,
                    dx: 100
                },
                {
                    note: { label: "First Teslas extend EV range limits", title: "2008" },
                    data: { year: 2008 },
                    dy: -30,
                    dx: -100
                },
                {
                    note: { label: "Affordable EVs gain in popularity", title: "2011" },
                    data: { year: 2011 },
                    dy: -150,
                    dx: 50
                },
                {
                    note: { label: "Tesla Model 3 bridges gap between luxury and affordability", title: "2017" },
                    data: { year: 2017 },
                    dy: -50,
                    dx: -20
                },
                {
                    note: { label: "Newest EVs still being researched for true range", title: "2022" },
                    data: { year: 2022 },
                    dy: -100,
                    dx: 60
                }
            ];

            const makeAnnotations3 = d3.annotation()
                .type(d3.annotationLabel)
                .annotations(annotations3)
                .accessors({
                    x: d => x3(d.year) + x3.bandwidth() / 4,
                    y: d => y3(d3.max([completeYearCounts3[d.year-1997].EV, completeYearCounts3[d.year-1997].Hybrid]))
                });

            svg3.append("g")
                .attr("class", "annotation-group scene3-annotations")
                .call(makeAnnotations3);

            d3.selectAll(".scene3-annotations g.annotation-connector, .scene3-annotations g.annotation-note")
                .style("display", "none");

            let annotationIndex3 = 0;

            function advanceAnnotation3() {
                const annotations = d3.selectAll(".scene3-annotations g.annotation-connector, .scene3-annotations g.annotation-note").nodes();
                if (annotationIndex3 < annotations.length) {
                    d3.select(annotations[annotationIndex3]).style("display", null);
                    d3.select(annotations[annotationIndex3 + 1]).style("display", null);
                    annotationIndex3 += 2;
                }
            }

            // Scene 4: User Exploration
            const exploration = d3.select("#exploration");
            const svg4 = d3.select("#exploration-chart")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // const g = svg4.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleBand().rangeRound([0, width]).padding(0.1);
            const yScale = d3.scaleLinear().rangeRound([height, 0]);

            const xAxis = svg4.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${height})`);

            const yAxis = svg4.append("g")
                .attr("class", "y-axis");

            function updateChart() {
                const xValue = document.getElementById('x-axis').value;
                const yValue = document.getElementById('y-axis').value;
                
                svg4.select(".s4-x-label").text(xValue);
                svg4.select(".s4-y-label").text(yValue);

                const filteredData = data.filter(d => {
                    const minYear = document.getElementById('left-year-range').value;
                    const maxYear = document.getElementById('right-year-range').value;
                    const minRange = document.getElementById('left-range-slider').value;
                    const maxRange = document.getElementById('right-range-slider').value;
                    const selectedMakes = Array.from(document.getElementById('make-dropdown').selectedOptions).map(option => option.value);
                    const selectedTypes = Array.from(document.getElementById('type-dropdown').selectedOptions).map(option => option.value);
                    const selectedModels = Array.from(document.getElementById('model-dropdown').selectedOptions).map(option => option.value);

                    d3.select("#left-year-range").attr("max", maxYear);
                    d3.select("#right-year-range").attr("min", minYear);

                    d3.select("#left-range-slider").attr("max", maxRange);
                    d3.select("#right-range-slider").attr("min", minRange);

                    return d.ModelYear >= minYear && d.ModelYear <= maxYear
                        && d.ElectricRange >= minRange && d.ElectricRange <= maxRange
                        && (selectedMakes.length === 0 || selectedMakes.includes(d.Make))
                        && (selectedTypes.length === 0 || selectedTypes.includes(d.ElectricVehicleType))
                        && (selectedModels.length === 0 || selectedModels.includes(d.Model));
                });

                let displayData;

                if (yValue === "CountOfVehicles") {
                    displayData = d3.nest()
                                    .key(d => d[xValue])
                                    .rollup(v => v.length)
                                    .entries(filteredData)
                                    .map(d => { return { [xValue]: d.key, count: d.value } });
                    xScale.domain(displayData.map(d => d[xValue]));
                    yScale.domain([0, d3.max(displayData, d => d.count)]).nice();
                } else {
                    displayData = filteredData;
                    xScale.domain(displayData.map(d => d[xValue]));
                    yScale.domain([0, d3.max(displayData, d => d[yValue])]).nice();
                }

                xAxis.call(d3.axisBottom(xScale));
                yAxis.call(d3.axisLeft(yScale));

                const bars = svg4.selectAll(".bar")
                    .data(displayData, d => d[xValue]);
                
                bars.enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", d => xScale(d[xValue]))
                    .attr("y", d => yScale(yValue === "CountOfVehicles" ? d.count : d[yValue]))
                    .attr("width", xScale.bandwidth())
                    .attr("height", d => height - yScale(yValue === "CountOfVehicles" ? d.count : d[yValue]))
                    .attr("fill", "steelblue");

                bars.transition().duration(750)
                    .attr("x", d => xScale(d[xValue]))
                    .attr("y", d => yScale(yValue === "CountOfVehicles" ? d.count : d[yValue]))
                    .attr("width", xScale.bandwidth())
                    .attr("height", d => height - yScale(yValue === "CountOfVehicles" ? d.count : d[yValue]));

                bars.exit().remove();
            }

            function updateModelDropdown() {
                const selectedMakes = Array.from(document.getElementById('make-dropdown').selectedOptions).map(option => option.value);
                const modelDropdown = d3.select("#model-dropdown");
                modelDropdown.html("");

                const filteredModels = data.filter(d => selectedMakes.includes(d.Make))
                    .map(d => d.Model);
                const uniqueModels = Array.from(new Set(filteredModels));

                uniqueModels.forEach(model => {
                    modelDropdown.append("option").attr("value", model).text(model);
                });

                updateChart();
            }

            function resetFilters() {
                document.getElementById('x-axis').value = 'ModelYear';
                document.getElementById('y-axis').value = 'ElectricRange';
                document.getElementById('left-year-range').value = 1997;
                document.getElementById('right-year-range').value = 2025;
                document.getElementById('left-range-slider').value = 0;
                document.getElementById('right-range-slider').value = 400;
                document.getElementById('make-dropdown').selectedIndex = -1;
                document.getElementById('type-dropdown').selectedIndex = -1;
                document.getElementById('model-dropdown').selectedIndex = -1;

                updateModelDropdown();
                updateChart();
            }
            
            // Populate dropdowns with unique values
            const makeOptions = Array.from(new Set(data.map(d => d.Make)));
            makeOptions.forEach(make => {
                d3.select("#make-dropdown").append("option").attr("value", make).text(make);
            });

            const typeOptions = Array.from(new Set(data.map(d => d.ElectricVehicleType)));
            typeOptions.forEach(type => {
                d3.select("#type-dropdown").append("option").attr("value", type).text(type);
            });

            svg4.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom)
                .attr("text-anchor", "middle")
                .attr("class", "s4-x-label");

            svg4.append("text")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 20)
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("class", "s4-y-label");

            // Add event listeners to update chart on change
            document.getElementById('x-axis').addEventListener('change', updateChart);
            document.getElementById('y-axis').addEventListener('change', updateChart);
            document.getElementById('left-year-range').addEventListener('change', updateChart);
            document.getElementById('right-year-range').addEventListener('change', updateChart);
            document.getElementById('left-range-slider').addEventListener('change', updateChart);
            document.getElementById('right-range-slider').addEventListener('change', updateChart);
            document.getElementById('make-dropdown').addEventListener('change', updateChart);
            document.getElementById('make-dropdown').addEventListener('change', updateModelDropdown);
            document.getElementById('type-dropdown').addEventListener('change', updateChart);
            document.getElementById('model-dropdown').addEventListener('change', updateChart);
            document.getElementById('reset-button').addEventListener('click', resetFilters);

            function showScene(index) {
                scenes.forEach((scene, i) => {
                    scene.classList.toggle('active', i === index);
                });
                prevBtn.style.display = index === 0 ? 'none' : 'inline-block';
                nextBtn.style.display = index === scenes.length - 1 ? 'none' : 'inline-block';
            }

            function nextScene() {
                if (currentScene < scenes.length - 1) {
                    currentScene++;
                    showScene(currentScene);
                    if (currentScene == 0) {
                        document.getElementById("advance-annotations").addEventListener("click", advanceAnnotation1);
                    }
                    else if (currentScene == 1) {
                        document.getElementById("advance-annotations").addEventListener("click", advanceAnnotation2);
                        document.getElementById("advance-annotations").removeEventListener("click", advanceAnnotation1);
                    }
                    else if (currentScene == 2) {
                        document.getElementById("advance-annotations").addEventListener("click", advanceAnnotation3);
                        document.getElementById("advance-annotations").removeEventListener("click", advanceAnnotation2);
                    }
                    else {
                        document.getElementById("advance-annotations").style.display = "none";
                    }
                }
            }

            function prevScene() {
                if (currentScene > 0) {
                    currentScene--;
                    showScene(currentScene);
                }
                if (currentScene == 0) {
                    document.getElementById("advance-annotations").addEventListener("click", advanceAnnotation1);
                    document.getElementById("advance-annotations").removeEventListener("click", advanceAnnotation2);
                }
                else if (currentScene == 1) {
                    document.getElementById("advance-annotations").addEventListener("click", advanceAnnotation2);
                    document.getElementById("advance-annotations").removeEventListener("click", advanceAnnotation3);
                }
                else if (currentScene == 2) {
                    document.getElementById("advance-annotations").style.display = null;
                    document.getElementById("advance-annotations").addEventListener("click", advanceAnnotation3);
                }
                else {
                    document.getElementById("advance-annotations").style.display = "none";
                }
            }

            document.getElementById("nextBtn").addEventListener("click", nextScene);
            document.getElementById("prevBtn").addEventListener("click", prevScene);

            // Initialize
            d3.selectAll(".scene2-annotations g.annotation-note-content")
                .attr("transform", "translate(-60, -120)");

            d3.selectAll(".scene2-annotations rect.annotation-note-bg")
                .attr("width", 120)
                .attr("height", 120);

            d3.selectAll(".scene2-annotations text.annotation-note-label")
                .attr("y", 18.7);

            d3.selectAll(".scene3-annotations g.annotation-note-content")
                .attr("transform", "translate(-60, -120)");

            d3.selectAll(".scene3-annotations rect.annotation-note-bg")
                .attr("width", 120)
                .attr("height", 120);

            d3.selectAll(".scene3-annotations text.annotation-note-label")
                .attr("y", 18.7);

            d3.selectAll('.scene2-annotations text.annotation-note-label tspan, .scene3-annotations text.annotation-note-label tspan')
                .each(function() {
                    let text = d3.select(this).text();

                    function splitText(text, charLimit) {
                        let words = text.split(' ');
                        let result = [];
                        let line = '';

                        words.forEach(word => {
                            if (line.length + word.length + 1 <= charLimit) {
                                line += (line.length ? ' ' : '') + word;
                            } else {
                                result.push(line);
                                line = word;
                            }
                        });
                        
                        if (line.length) {
                            result.push(line);
                        }

                        return result;
                    }

                    let splitTextArray = splitText(text, 18);

                    let newHeight = (splitTextArray.length) * 20 + 20;

                    let parentTextElement = d3.select(this.parentNode);

                    let a = d3.select(parentTextElement.node().parentNode)
                        .attr('transform', 'translate(-60, -' + newHeight + ')')
                        .select('rect.annotation-note-bg')
                        .attr('height', newHeight);

                    splitTextArray.forEach((text, i) => {
                        parentTextElement
                            .append('tspan')
                            .attr('x', 0)
                            .attr('dy', i == 0 ? '0.8em' : "1.2em")
                            .text(text);
                    });

                    d3.select(this).remove();
                });


            showScene(currentScene);
            resetFilters();
            updateChart();
            updateModelDropdown();
        });
    </script>
</body>
</html>